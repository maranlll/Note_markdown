# 第三章 数据链路层

数据链路层主要的信道有以下两种：
1.点对点信道。2.广播信道

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

链路就是一条无源的点到点的物理线路段，中间没有任何其他的交换节点。
数据链路 (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
帧：点对点信道的数据链路层的协议数据单元。
点对点信道的数据链路层在进行通信时的主要步骤为：
1.结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧。
2.结点A把封装好的帧发给结点B的数据链路层。
3.若结点B的数据链路层收到的帧无差错，则从收到的帧中提取出IP数据报交给上面的网络层；否则丢失这个帧。

### 3.1.2 三个基本问题

1.封装成帧：
在一段数据的前后分别添加首部和尾部，然后构成一个帧。首部和尾部的一个重要作用就是进行帧定界。
控制字符 SOH(01) 放在一帧的最前面，表示帧的首部开始，另一个控制字符 EOT(04) 表示帧的结束。
2.透明传输：
如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”。
解决方法：字节填充、字符填充。
发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(1B)。接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。
3.差错检测：
在传输过程中可能会产生比特差错：1 可能会变成 0， 而 0 也可能变成 1。
在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER 。
广泛采用循环冗余检验CRC。在数据后面添加上的冗余码称为帧检验序列 FCS 。
仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受。单纯使用 CRC 差错检测技术不能实现“无差错传输”或“可靠传输”

## 3.2 点对点协议PPP

互联网用户通常都要连接到某个ISP才能接入互联网，PPP协议就是计算机和ISP进行通信时所使用的数据链路层协议。

### 3.2.1 PPP协议的特点

1.PPP协议应满足的要求
简单（首要的要求）、封装成帧、透明性、多种网络层协议、多种类型链路、差错检测、检测连接状态、最大传送单元、网络层地址协商、数据压缩协商。
2.组成：一个将IP数据报封装到串行链路的方法、链路控制协议LCP、网络控制协议NCP（每一个协议支持不同的网络层协议）

### 3.2.2 PPP协议的帧格式

标志字段 0x7E 表示一个帧的开始或结束。

3.（异步传输）字符填充：
$0x7E \to 0x7D,0x5E$
$0x7D \to 0x7D, 0x5D$
小于0x20, 在前面加0x7D,并将该字符加以转变

4.（同步传输）零比特传输：只要有连续 5 个 1，则立刻填入一个 0。

### 3.2.3 PPP协议的工作状态

当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

## 3.3 使用广播信道的数据链路层

### 3.3.1 局域网的数据链路层

局域网最主要的特点：
1.玩过为一个单位所拥有
2.地理范围和站点数量均有限

局域网有以下主要优点：
1.具有广播功能，从一个站点可很方便地访问全网，局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
2.便于系统的扩展和逐渐的演变，各设备的位置可灵活调整和改变。
3.提高了系统的可靠性、可用性和残存性。

媒体共享技术：
静态划分信道：频分复用，时分复用，波分复用，码分复用。
动态媒体接入控制（多点接入）：随机接入；受控接入。

以太网的两个标准：
DIX Ethernet V2是世界上第一个局域网产品的规约。
IEEE 802.3是第一个IEEE的以太网标准。

局域网的数据链路层拆分成两个子层：1.逻辑链路控制 LLC 子层。2.媒体接入控制 MAC 子层。
不管采用何种协议的局域网，对LLC子层来说都是透明的（LLC子层看不见下面的局域网）。

适配器的重要功能：
1.进行串行/并行转换。
2.对数据进行缓存。
3.在计算机的操作系统安装设备驱动程序。
4.实现以太网协议。

### 3.3.2 CSMA/CD协议

以太网采取了两种重要的措施：
1.采用较为灵活的无连接的工作方式。
2.以太网发送的数据都是曼彻斯特编码。
曼彻斯特编码缺点是：它所占的频带宽度比原始的基带信号增加了一倍

CSMA/CD：载波监听多点接入/碰撞检测
碰撞检测：计算机边发数据边检测信道上的信号电压大小。
每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。
$2 \tau$时间后（两倍端到端往返时延）的争用期间未检测到碰撞就可肯定这次发送不会发生碰撞。
基本退避时间为争用期$2 \tau$。重传的等待时间是 r 倍的基本退避时间。

10 Mbit/s 以太网争用期的长度：
$51.2 \mu s$，此争用期内科发送 512 bit，即64字节，这意味着如果前64字节没有发生冲突，则后续数据就不会发生冲突。
以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲入而异常终止的无效帧。
以太网上的最大的端到端单程实验必须小于争用期的一半（$25.6 \mu s$），这相当于以太网的最大端到端的长度约为5km。

二进制指数类型退避算法：
发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。
1.基本退避时间取为争用期 $2 \tau$ 。
2.从整数集合 $[0, 1, … , (2^k - 1)]$ 中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。
3.参数 k 按下面的公式计算：
k = Min[重传次数, 10]
4.当 k ≤10 时，参数 k 等于重传次数。
5.当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。 


### 3.3.3 使用集线器的星形拓扑

星形以太网 10BASE-T：使用无屏蔽双绞线，采用星形拓扑。每个站需要使用两队双绞线，分别用于发送和接受。集线器使用了大规模集成电路芯片，因此可靠性提高，通信距离较短，每个站到集线器的距离不超过100m。

意义：
这种 10 Mbit/s 速率的无屏蔽双绞线星形网的出现，既降低了成本，又提高了可靠性。 具有很高的性价比。
10BASE-T 双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。
从此以太网的拓扑就从总线形变为更加方便的星形网络，而以太网也就在局域网中占据了统治地位。 

集线器工作在物理层。

### 3.3.4 以太网的信道利用率

成功发送一个帧所需要占用信道的时间是 $T_0 + \tau$，$T_0$ 是发送帧所需要的时间。
要提高以太网信道的利用率，就必须减少 $\tau$ 与 $T_0$之比。
$\alpha = \frac{\tau}{T_0}$
在以太网中定义了参数 $\alpha$ ，他是以太网单程端到端时延 $\tau$与发送时间 $T_0$ 之比。$\alpha$ 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使信道利用率明显降低。
对以太网参数 $\alpha$ 的要求是：
1.当数据量一定时，以太网的连线长度受到限制，否则 $\tau$的数值会太大。
2.以太网的帧长不能太短，否则 $T_0$ 的值会太小，使 $\alpha$ 值太大。

理想情况下极限信道利用率 $S_{max}$ 为 $S_{max} = \frac{T_0}{T_0 + \tau} = \frac{1}{1 + \alpha}$

### 3.3.5 以太网的 MAC 层

MAC帧的格式：
1.DIX Ethernet V标准
2.IEEE 的 802.3 标准
最常用的 MAC 帧是以太网 V2 的格式。

前两个字段分别为 6 字节长的目的地址和源地址字段。第三个字段是 2 字节的类型字段，用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。第四个字段是数据字段，其长度在 46 到 1500 字节之间。最后一个字段是 4 字节的帧检测序列FCS。

无效的 MAC 帧：
数据字段的长度与长度字段的值不一致；
帧的长度不是整数个字节；
用收到的帧检验序列 FCS 查出有差错；
数据字段的长度不在 46 ~ 1500 字节之间。

IEEE 802.3 MAC帧格式：
第三个字段是“长度/类型”。待遇0x600时（十进制1536），表示类型。小于时表示长度，且此时必须装入逻辑链路控制LLC子层的LLC帧。

帧间最小间隔：$9.6 \mu s$，相当于 96 bit的发送时间，即一个站在检测到总线开始空闲后，还要等待 $9.6 \mu s$才能再次发送数据，为了使刚刚收到数据帧的站的接受缓存来得及清理，做好接受下一帧的准备。

## 3.4 扩展的以太网

### 3.4.1 在物理层扩展以太网

用集线器扩展以太网：
优点：使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信。扩大了以太网覆盖的地理范围。
缺点：碰撞域增大了，但总的吞吐量并未提高。如果不同的碰撞域使用不同的数据率，那么就不能用集线器将他们互连起来。

碰撞域又称为冲突域，是指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。三个最大吞吐量为 10 Mbit/s 的以太网互连起来后系统最大总吞吐量依旧为 10 Mbit/s。

### 3.4.2 在数据链路层扩展以太网（常用的方法）

早期使用网桥，现在使用以太网交换机。

以太网交换机实质上就是一个多接口的网桥，工作在全双工方式，有并行性。

以太网交换机的特点：
以太网交换机的接口有存储器，能在输出端口繁忙时把到来的帧进行缓存。
以太网交换机是一种即插即用设备，其内部的帧交换表（又称为地址表）是通过自学习算法自动地逐渐建立起来的。
以太网交换机使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多。
以太网交换机的性能远远超过普通的集线器，而且价格并不贵。
优点：
用户独享带宽，增加了总容量。
从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动。
以太网交换机一般都具有多种速率的接口，方便了各种不同情况的用户。

以太网交换机的交换方式：
存储转发方式，直通方式。

交换机使用了生成树协议，不改变网络的实际拓扑，使从一台主机到所有其他主机的路径是无环路的树状结构。

总线型以太网：CSMA/CD、半双工。
以太网交换机：无碰撞问题，不使用CSMA/CD、全双工。

总线以太网和10BASE_T星形以太网：所有计算机都在同一个碰撞域和广播域中。
采用以太网交换机的星形以太网：每个接口处于独立的碰撞域，但所有计算机处于同一个广播域中。

### 3.4.3 虚拟局域网

虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组。
优点：改善了性能，简化了管理，降低了成本，改善了安全性。

虚拟局域网使用的以太网帧格式加了4字节的标记。

## 3.5 高速以太网

### 3.5.1 100BASE-T 以太网

特点：可在全双工方式下工作而无冲突发生，此时不适用CSMA/CD协议。帧格式不变，最短帧长不变，为了使$\alpha$不变，最大电缆长度减小为100米。帧间间隔改为$0.96 \mu s$。

### 3.5.2 吉比特以太网

在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。
为了保持最小帧长度64字节，网段最大长度100米：增加了两个功能：载波延伸，分组突发。
载波延伸：
争用时间增长为512字节，凡发送的MAC帧长不足512字节时，就用一些特殊字符填充在帧的后面增长为512字节，接收端接收后将所填充的特殊字符删除后向高层交付。
分组突发：当很多短帧要发送是，第一个短帧用载波延伸的方法进行填充，随后的一些短帧可以一个接一个地发送，只要留有必到的帧间最小间隔即可，形成一串分组地突发，直到达到1500字节或稍多一些。

全双工时不使用载波延伸和分组突发。

### 3.5.3 10 吉比特以太网和更快的以太网

只工作在全双工方式，无争用问题，不使用CSMA/CD协议。

端到端的以太网传输的好处：
技术成熟；
互操作性很好；
在广域网中使用以太网时价格便宜；
采用统一的以太网帧格式，简化了操作和管理。

### 3.5.4 使用以太网进行宽带接入

特点：
可以提供双向的宽带通信。
可以根据用户对带宽的需求灵活地进行带宽升级。
可以实现端到端的以太网传输，中间不需要再进行帧格式的转换。这就提高了数据的传输效率且降低了传输的成本。
但是不支持用户身份鉴别。

PPPoE：在以太网上运行PPP，把PPP协议与以太网协议结合起来，将PPP帧再封装到以太网中来传输。

用PPPoE弹出的窗口进行宽带上网。
